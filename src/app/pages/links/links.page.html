<ion-content class="ion-padding">

  <ion-segment [(ngModel)]="tab">
    <ion-segment-button value="create">Créer</ion-segment-button>
    <ion-segment-button value="status">Statut</ion-segment-button>
  </ion-segment>

  <!-- === CREATE === -->
  @if (tab === 'create') {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Créer un lien (unitaire)</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form [formGroup]="form" (ngSubmit)="createSingle()">
          <ion-item>
            <ion-input label="Identifiant" formControlName="item_id" [required]="true"/>
          </ion-item>
          <ion-item>
            <ion-textarea label="Secret" formControlName="secret" [autoGrow]="true" [required]="true"></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-input type="number" label="Durée de vie du lien" formControlName="ttl_days">
              <ion-button fill="clear" slot="end" id="infoTTL">
                <ion-icon name="information-circle-outline"></ion-icon>
              </ion-button>
              <ion-popover trigger="infoTTL" triggerAction="click" [showBackdrop]="false">
                <ng-template>
                  <ion-content class="ion-padding">
                    Durée de validité du lien en jours. Par défaut 7 jours. Mettre 0 pour un lien sans expiration.
                  </ion-content>
                </ng-template>
              </ion-popover>
            </ion-input>
          </ion-item>

          <ion-button type="submit" [disabled]="form.invalid || loading">Créer</ion-button>
        </form>

        @if (lastResults?.length && form.get('item_id')) {
          <ion-list>
            <ion-list-header>Résultat</ion-list-header>
            @for (r of lastResults; track r.item_id) {
              <ion-item>
                <ion-label>
                  <b>{{ r.item_id }}</b> — {{ statusHelp[r.status] }}

                  @if (r.link_token) {
                    <a [href]="linkUrl(r.link_token)" target="_blank">{{ linkUrl(r.link_token) }}</a>
                  }

                  @if (r.expires_at) {
                    <div>Expire : {{ r.expires_at | date:'medium' }}</div>
                  }
                </ion-label>
                @if (r.link_token) {
                  <ion-button fill="clear" (click)="copy(linkUrl(r.link_token))">Copier</ion-button>
                }
              </ion-item>
            }
          </ion-list>
        }

      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Créer en bulk (coller CSV)</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-note>Colonnes supportées: <code>item_id,secret,ttl_days</code> — entête optionnelle.</ion-note>
        <ion-textarea [(ngModel)]="csvText" [ngModelOptions]="{standalone:true}" [autoGrow]="true" [rows]="6"
                      placeholder="item_id,secret,ttl_days
alice@example.com,vpn-ALICE,7
bob@example.com,vpn-BOB,7"></ion-textarea>
        <div class="row">
          <ion-input
            label="(Optionnel) PAT Bearer"
            [(ngModel)]="inlinePatBulk"
            [ngModelOptions]="{standalone:true}"
            placeholder="laisser vide pour session"/>

          <ion-input
            label="(Optionnel) Idempotency-Key"
            [(ngModel)]="idempotencyKey"
            [ngModelOptions]="{standalone:true}"
            [clearInput]="true"
            (ionInput)="idempotencyKey === '' ? clearKey() : null"
            placeholder="ex: bulk-20251008-153045-3fa7bd">
            <ion-button fill="clear" slot="end" (click)="generateKey()">
              <ion-icon name="sync-outline"/>
            </ion-button>
          </ion-input>
        </div>

        <ion-button (click)="createBulk()" [disabled]="loading || !csvText.trim()">Créer les liens</ion-button>

        @if (lastResults?.length && !form.get('item_id')) {
          <ion-list>
            @for (r of lastResults; track r.item_id) {
              <ion-item>
                <ion-label>
                  <b>{{ r.item_id }}</b> — {{ r.status }}
                  @if (r.link_token) {
                    <div><a [href]="linkUrl(r.link_token)" target="_blank">{{ linkUrl(r.link_token) }}</a></div>
                  }
                </ion-label>

                @if (r.link_token) {
                  <ion-button fill="clear" (click)="copy(linkUrl(r.link_token))">Copier</ion-button>
                }
              </ion-item>
            }
          </ion-list>
        }
      </ion-card-content>
    </ion-card>
  }


  <!-- === STATUS === -->
  @if (tab === 'status') {
    <ion-card>
      <ion-card-header>
        <ion-item lines="none">
          <ion-card-title>
            Statut des liens
          </ion-card-title>
          <ion-button fill="outline" (click)="exportCsv()" [disabled]="!filteredRows().length" slot="end">
            Exporter CSV
          </ion-button>
        </ion-item>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-segment [value]="statusFilter().toString()" (ionChange)="setStatusFilter($event.detail.value ?? 'all')">
            <ion-segment-button value="active">
              <div class="badge-align">
                Actifs <ion-badge>{{ countActive() }}</ion-badge>
              </div>
            </ion-segment-button>

            <ion-segment-button value="used">
              <div class="badge-align">
                Utilisés <ion-badge>{{ countUsed() }}</ion-badge>
              </div>
            </ion-segment-button>

            <ion-segment-button value="deleted">
              <div class="badge-align">
                Supprimés <ion-badge>{{ countDeleted() }}</ion-badge>
              </div>
            </ion-segment-button>

            <ion-segment-button value="expired">
              <div class="badge-align">
                Expirés <ion-badge>{{ countExpired() }}</ion-badge>
              </div>
            </ion-segment-button>

            <ion-segment-button value="all">
              Tous
            </ion-segment-button>
          </ion-segment>
        </ion-item>

        <ion-item lines="none">
          <ion-input placeholder="Rechercher (item_id ou token)…"
                     (ionInput)="setQuery($event.target['value']?.toString() || '')">
          </ion-input>
        </ion-item>


        <ion-list>
          @for (row of filteredRows(); track row.link_token) {
            <ion-item>
              <ion-label>
                <div class="badge-align">
                  <b>{{ row.item_id }}</b>
                  @if (statusOf(row) === 'active') {
                    <ion-badge color="success">Actif</ion-badge>
                  }
                  @if (statusOf(row) === 'used') {
                    <ion-badge color="medium">Utilisé</ion-badge>
                  }
                  @if (statusOf(row) === 'deleted') {
                    <ion-badge color="warning">Supprimé</ion-badge>
                  }
                  @if (statusOf(row) === 'expired') {
                    <ion-badge color="tertiary">Expiré</ion-badge>
                  }
                </div>
                <div class="dim">Créé: {{ row.created_at | date: 'short' }}</div>
                <div class="dim">Expire: {{ row.expires_at ? (row.expires_at | date:'short') : '—' }}</div>
                <div class="dim">Utilisé: {{ row.used_at ? (row.used_at | date:'short') : '—' }}</div>
                <div class="dim">Supprimé: {{ row.deleted_at ? (row.deleted_at | date:'short') : '—' }}</div>
              </ion-label>

              <ion-buttons slot="end">
                <ion-button fill="clear" (click)="copy(linkUrl(row.link_token))" [disabled]="!row.link_token">
                  Copier lien
                </ion-button>

                <ion-button color="danger" (click)="delete(row.link_token)"
                            [disabled]="!!row.deleted_at || !!row.used_at">Supprimer
                </ion-button>
              </ion-buttons>
            </ion-item>
          }
        </ion-list>

        @if (!filteredRows().length) {
          <ion-item lines="none">
            <ion-label>Aucun lien pour ce filtre/recherche.</ion-label>
          </ion-item>
        }
      </ion-card-content>
    </ion-card>
  }
</ion-content>
