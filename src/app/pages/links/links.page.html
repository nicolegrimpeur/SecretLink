<ion-content class="ion-padding">

  <ion-segment [(ngModel)]="tab">
    <ion-segment-button value="create">Créer</ion-segment-button>
    <ion-segment-button value="status">Statut</ion-segment-button>
  </ion-segment>

  <!-- === CREATE === -->
  @if (tab === 'create') {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Créer un lien sécurisé</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <form [formGroup]="form" (ngSubmit)="createSingle()">
          <ion-item lines="none">
            <ion-input
              label="Identifiant :"
              formControlName="item_id"
              [required]="true"
              helperText="L'identifiant unique du secret. Ne peut pas être déjà utilisé sur un secret actif."
              [errorText]="errorFor('item_id') || ''"
              [maxlength]="320"
            />
          </ion-item>
          <ion-item lines="none">
            <ion-textarea
              label="Secret :"
              formControlName="secret"
              [autoGrow]="true"
              [required]="true"
              helperText="Le secret associé à l'identifiant."
              [errorText]="errorFor('secret') || ''"
              [counter]="true"
              [maxlength]="4096"
            />
          </ion-item>
          <ion-item lines="none">
            <ion-input
              type="number"
              inputmode="numeric"
              label="Durée de vie du lien :"
              formControlName="ttl_days"
              min="0"
              max="365"
              helperText="Durée en jours, peut être égal à 0 pour un lien sans expiration."
              [errorText]="errorFor('ttl_days') || ''"
            />
          </ion-item>

          <div class="ion-display-flex ion-justify-content-center">
            <ion-button type="submit" [disabled]="form.invalid || loading">Créer</ion-button>
          </div>
        </form>

        @if (lastResults?.length && Number(lastResults?.length) === 1) {
          <ion-list>
            @for (r of lastResults; track r.item_id) {
              <ion-item>
                <ion-label>
                  <b>{{ r.item_id }}</b> — {{ statusHelp[r.status] }}

                  @if (r.link_token) {
                    <a [href]="linkUrl(r.link_token)" target="_blank">{{ linkUrl(r.link_token) }}</a>
                  }

                  @if (r.expires_at) {
                    <div>Expire : {{ r.expires_at | date:'medium' }}</div>
                  }
                </ion-label>
                @if (r.link_token) {
                  <ion-button fill="clear" (click)="copy(linkUrl(r.link_token))">Copier</ion-button>
                }
              </ion-item>
            }
          </ion-list>
        }

      </ion-card-content>
    </ion-card>

    <div class="ion-display-flex ion-justify-content-center ion-margin-vertical">
      <ion-checkbox [(ngModel)]="showBulk" [ngModelOptions]="{standalone:true}" color="primary">
        <ion-label color="medium">Afficher les options avancées</ion-label>
      </ion-checkbox>
    </div>

    @if (showBulk) {
      <ion-card class="fade-in">
        <ion-card-header>
          <ion-card-title>Créer en bulk (coller CSV)</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-note>Colonnes supportées: <code>item_id,secret,ttl_days</code> — entête optionnelle.</ion-note>
          <ion-textarea
            [(ngModel)]="csvText"
            [ngModelOptions]="{standalone:true}"
            [autoGrow]="true"
            [rows]="6"
            placeholder="item_id,secret,ttl_days
alice@example.com,vpn-ALICE,7
bob@example.com,vpn-BOB,7"></ion-textarea>

          <div class="ion-display-flex ion-justify-content-center">
            <ion-button (click)="createBulk()" [disabled]="loading || !csvText.trim()">Créer les liens</ion-button>
          </div>

          @if (lastResults?.length && Number(lastResults?.length) > 1) {
            <ion-list>
              @for (r of lastResults; track r.item_id) {
                <ion-item>
                  <ion-label>
                    <b>{{ r.item_id }}</b> — {{ statusHelp[r.status] }}
                    @if (r.link_token) {
                      <div><a [href]="linkUrl(r.link_token)" target="_blank">{{ linkUrl(r.link_token) }}</a></div>
                    }
                  </ion-label>

                  @if (r.link_token) {
                    <ion-button fill="clear" (click)="copy(linkUrl(r.link_token))">Copier</ion-button>
                  }
                </ion-item>
              }
            </ion-list>
          }
        </ion-card-content>
      </ion-card>
    }
  }


  <!-- === STATUS === -->
  @if (tab === 'status') {
    <ion-card>
      <ion-card-header>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="2" class="ion-display-flex ion-align-items-center">
              <ion-card-title>
                Statut des liens
              </ion-card-title>
            </ion-col>
            <ion-col size="2" class="ion-hide-md-down"></ion-col>
            <ion-col size="8" class="ion-hide-md-down">
              <ion-segment [value]="statusFilter().toString()"
                           (ionChange)="setStatusFilter($event.detail.value ?? 'all')">
                <ion-segment-button value="active">
                  <div class="badge-align">
                    Actifs
                    <ion-badge>{{ countActive() }}</ion-badge>
                  </div>
                </ion-segment-button>

                <ion-segment-button value="used">
                  <div class="badge-align">
                    Utilisés
                    <ion-badge>{{ countUsed() }}</ion-badge>
                  </div>
                </ion-segment-button>

                <ion-segment-button value="deleted">
                  <div class="badge-align">
                    Supprimés
                    <ion-badge>{{ countDeleted() }}</ion-badge>
                  </div>
                </ion-segment-button>

                <ion-segment-button value="expired">
                  <div class="badge-align">
                    Expirés
                    <ion-badge>{{ countExpired() }}</ion-badge>
                  </div>
                </ion-segment-button>

                <ion-segment-button value="all">
                  Tous
                </ion-segment-button>
              </ion-segment>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-header>
      <ion-card-content>
        <ion-list class="ion-no-padding">
          <ion-item lines="none">
            <ion-input placeholder="Rechercher par identifiant"
                       color="primary"
                       [(ngModel)]="statusSearch"
                       [ngModelOptions]="{standalone:true}"
                       [clearInput]="true"
                       (ionInput)="forceRefresh()"
            />
            <ion-button fill="outline" (click)="exportCsv()" [disabled]="!filteredRows().length" slot="end">
              Exporter CSV
            </ion-button>
          </ion-item>

          <ion-item class="grid-header ion-no-padding ion-text-center">
            <ion-col size="8" size-md="3"><b>Identifiant / Statut</b></ion-col>
            <ion-col size="2" class="ion-hide-md-down"><b>Créé le</b></ion-col>
            <ion-col size="2" class="ion-hide-md-down"><b>Expire le</b></ion-col>
            <ion-col size="2" class="ion-hide-md-down"><b>Utilisé le</b></ion-col>
            <ion-col size="2" class="ion-hide-md-down"><b>Supprimé le</b></ion-col>
            <ion-col size="4" size-md="1"><b>Actions</b></ion-col>
          </ion-item>

          @for (row of filteredRows(); track row.link_token) {
            <ion-item class="grid-item ion-no-padding" lines="none">
              <!-- Identifiant + Badges -->
              <ion-col size="8" size-md="3" class="grid-col ion-text-center">
                <div class="badge-align">
                  <b [title]="row.item_id">
                    {{ row.item_id.length > 20 ? row.item_id.slice(0, 20) + '...' : row.item_id }}
                  </b>
                  @if (statusOf(row) === 'active') {
                    <ion-badge color="success" class="tight">Actif</ion-badge>
                  }
                  @if (statusOf(row) === 'used') {
                    <ion-badge color="medium" class="tight">Utilisé</ion-badge>
                  }
                  @if (statusOf(row) === 'deleted') {
                    <ion-badge color="danger" class="tight">Supprimé</ion-badge>
                  }
                  @if (statusOf(row) === 'expired') {
                    <ion-badge color="warning" class="tight">Expiré</ion-badge>
                  }
                </div>
              </ion-col>

              <!-- Dates -->
              <ion-col size="2" class="ion-hide-md-down grid-col ion-text-center">
                {{ row.created_at | date:'short' }}
              </ion-col>

              <ion-col size="2" class="ion-hide-md-down grid-col ion-text-center">
                {{ row.expires_at ? (row.expires_at | date:'short') : '—' }}
              </ion-col>

              <ion-col size="2" class="ion-hide-md-down grid-col ion-text-center">
                {{ row.used_at ? (row.used_at | date:'short') : '—' }}
              </ion-col>

              <ion-col size="2" class="ion-hide-md-down grid-col ion-text-center">
                {{ row.deleted_at ? (row.deleted_at | date:'short') : '—' }}
              </ion-col>

              <!-- Actions -->
              <ion-col size="4" size-md="1" class="ion-display-flex ion-justify-content-center">
                <ion-buttons class="separate-buttons">
                  <ion-button
                    fill="clear"
                    shape="round"
                    (click)="copy(linkUrl(row.link_token))"
                    [disabled]="!!row.deleted_at || !!row.used_at || isLinkExpired(row)">
                    <ion-icon name="copy-outline"></ion-icon>
                  </ion-button>

                  <ion-button
                    color="danger"
                    shape="round"
                    (click)="askBeforeDelete(row.link_token)"
                    [disabled]="!!row.deleted_at || !!row.used_at || isLinkExpired(row)">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                </ion-buttons>
              </ion-col>
            </ion-item>
          }

          @if (!filteredRows().length) {
            <ion-item lines="none">
              <ion-label>Aucun lien pour ce filtre/recherche.</ion-label>
            </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
  }
</ion-content>
