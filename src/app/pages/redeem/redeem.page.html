<ion-content>
  <div class="redeem-container">
    @if (state === 'ready') {
      <ion-card class="redeem-card large-card">
        <ion-card-header>
          <ion-card-title>Ce lien est à usage unique</ion-card-title>
          <ion-card-subtitle>Le secret sera affiché une seule fois</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <ion-item lines="none">
            <ion-checkbox [(ngModel)]="ack" [ngModelOptions]="{standalone:true}" justify="start" id="checkbox-ack">
              <div class="ion-text-wrap">J’ai compris qu’il ne sera plus accessible après affichage</div>
            </ion-checkbox>
          </ion-item>
          <ion-button expand="block" [disabled]="!ack || loading" (click)="reveal()">Afficher le secret</ion-button>
          <p class="hint">Conseil : ne stockez pas ce secret dans un email. Copiez-le puis conservez-le en lieu sûr
            (gestionnaire de mots de passe, etc.).</p>
        </ion-card-content>
      </ion-card>
    }

    @if (state === 'loading') {
      <ion-card class="redeem-card small-card">
        <ion-card-header>
          <ion-card-title>Chargement…</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-skeleton-text [animated]="true" style="height: 80px"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    }

    @if (state === 'passphrase_required') {
      <ion-card class="redeem-card large-card">
        <ion-card-header>
          <ion-card-title>Passphrase requise</ion-card-title>
          <ion-card-subtitle>Ce secret est protégé par une passphrase</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <form [formGroup]="form" (ngSubmit)="reveal()">
            <ion-item lines="none">
              <ion-input label="Passphrase :" type="password" formControlName="passphrase" errorText="Champ requis.">
                <ion-input-password-toggle slot="end"></ion-input-password-toggle>
              </ion-input>
            </ion-item>
            <ion-button expand="block" [disabled]="!form.valid" (click)="reveal()">Afficher le secret
            </ion-button>
            @if (isPassphraseInvalid) {
              <ion-text color="danger">
                La passphrase est incorrecte. Veuillez réessayer.
              </ion-text>
            }
          </form>
        </ion-card-content>
      </ion-card>
    }

    @if (state === 'success') {
      <ion-card class="redeem-card large-card">
        <ion-card-header>
          <ion-card-title>Secret révélé</ion-card-title>
          <ion-card-subtitle>Identifiant : {{ itemId }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <ion-item lines="none" class="ion-no-padding">
            <ion-textarea label="Secret :" type="text" [value]="secret" [readonly]="true" auto-grow>
              <ion-button (click)="copy()" slot="end">
                <ion-icon name="copy-outline"></ion-icon>
              </ion-button>
            </ion-textarea>
          </ion-item>
        </ion-card-content>
        <ion-card-content>
          Ce secret ne sera plus disponible en rechargeant cette page ou en rouvrant le lien.
        </ion-card-content>
      </ion-card>
    }

    @if (state === 'error') {
      <ion-card class="redeem-card invalid-code small-card">
        <ion-card-header>
          <ion-card-title>Lien invalide ou expiré</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="hint">{{ errorMessage }}</p>
        </ion-card-content>
      </ion-card>
    }
  </div>
</ion-content>
